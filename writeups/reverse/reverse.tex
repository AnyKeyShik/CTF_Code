%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Daily Laboratory Book
% LaTeX Template
% Version 1.0 (4/4/12)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% Frank Kuster (http://www.ctan.org/tex-archive/macros/latex/contrib/labbook/)
%
% Important note:
% This template requires the labbook.cls file to be in the same directory as the
% .tex file. The labbook.cls file provides the necessary structure to create the
% lab book.
%
% The \lipsum[#] commands throughout this template generate dummy text
% to fill the template out. These commands should all be removed when 
% writing lab book content.
%
% HOW TO USE THIS TEMPLATE 
% Each day in the lab consists of three main things:
%
% 1. LABDAY: The first thing to put is the \labday{} command with a date in 
% curly brackets, this will make a new page and put the date in big letters 
% at the top.
%
% 2. EXPERIMENT: Next you need to specify what experiment(s) you are 
% working on with an \experiment{} command with the experiment shorthand 
% in the curly brackets. The experiment shorthand is defined in the 
% 'DEFINITION OF EXPERIMENTS' section below, this means you can 
% say \experiment{pcr} and the actual text written to the PDF will be what 
% you set the 'pcr' experiment to be. If the experiment is a one off, you can 
% just write it in the bracket without creating a shorthand. Note: if you don't 
% want to have an experiment, just leave this out and it won't be printed.
%
% 3. CONTENT: Following the experiment is the content, i.e. what progress 
% you made on the experiment that day.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[idxtotoc,hyperref,openany,oneside]{files/reverse} % 'openany' here removes the gap page between days, erase it to restore this gap; 'oneside' can also be added to remove the shift that odd pages have to the right for easier reading

\usepackage[ 
  backref=page,
  pdfpagelabels=true,
  plainpages=false,
  colorlinks=true,
  bookmarks=true,
  pdfview=FitB]{hyperref} % Required for the hyperlinks within the PDF
  
\usepackage{booktabs} % Required for the top and bottom rules in the table
\usepackage{float} % Required for specifying the exact location of a figure or table
\usepackage{graphicx} % Required for including images2
\usepackage{listings} % Used for programs' listings
\usepackage{tcolorbox} % For textboxes

\usepackage[english,russian]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Command to make the lines in the title page
\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%	DEFINITION OF EXPERIMENTS
%----------------------------------------------------------------------------------------

\newexperiment{easy1}{Check the license!}
\newexperiment{easy2}{Guess the password}
\newexperiment{medium}{<Название>}
\newexperiment{hard}{<Название>}
\newexperiment{reallife}{<Название>}

%---------------------------------------------------------------------------------------

\begin{document}

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\frontmatter % Use Roman numerals for page numbers
\title{
\begin{center}
\HRule \\[0.4cm]
{\Huge \bfseries CTF Code \\[0.5cm] \Large Writeups}\\[0.4cm] % Degree
\HRule \\[1.5cm]
\end{center}
}
\author{\Huge Reverse Engineering \\ \\[2cm]} % Your name and email address
\maketitle

\tableofcontents

\mainmatter % Use Arabic numerals for page numbers

%----------------------------------------------------------------------------------------
%	LAB BOOK CONTENTS
%----------------------------------------------------------------------------------------

% Blank template to use for new days:

%\labday{Day, Date Month Year}

%\experiment{}

%Text

%-----------------------------------------

%\experiment{}

%Text

%----------------------------------------------------------------------------------------

\labday{Easy}

\experiment{easy1}

\textbf{Теги:} Java, License key\vspace{\baselineskip}

\begin{tcolorbox}
<условие задачи>
\end{tcolorbox}

Нам дается программа на Java, которая хочет какую-то лицензию. Самое время ее разреверсить и посмотреть, что же там за лицензия нам нужна. Так как это Java, то можно восстановить исходный код с точностью до имен переменных с помощью любого декомпилятора. В райтапе будет использоваться JD-GUI. После открытия файла видим, что он совсем небольшой и состоит всего из трех классов:
\begin{figure}[H]
\begin{center}
\includegraphics[width=0.7\linewidth]{files/java-classes}
\end{center}
\caption{Java изнутри}
\label{fig:java-classes}
\end{figure}

После рассмотрения \verb|Main|'a понимаем, что это просто драйвер и ничего связанного с лицензией или ее обработкой не делает. С классом \verb|LicenseHandler| ситуация интереснее, но тоже ничего нужного нам - ни расшифровки, ни каких-либо проверок. Просто чтение из класса и обращение к классу \verb|Cryptor|, который, судя по всему, нам и нужен. Декомпилируем и смотрим:
\begin{figure}[H]
\begin{center}
\includegraphics[width=0.7\linewidth]{files/java-cryptor}
\end{center}
\caption{Когда создал свою крипту}
\label{fig:java-classes}
\end{figure}

С первого взгляда флаг лежит прямо перед нами. Но это как-то слишком просто даже для easy-задачи. Посмотрим чуть ниже. Дейсвительно, сначала происходит какая-то проверка хэша. Если посмотреть внимательнее - никаких хешей нет. Сначала проверяем, что длина лицензии 17 символов, потом просто массив байтиков, с 9 по 15 элементы, сверяется с константой \verb|HASH_PATTERN|. После чего в функции \verb|decrypt| собирается флаг - обертка остается без изменений, а вот 7 символов ксорятся с \verb|HASH_PATTERN|. После чего совсем не сложно написать простенький скрипт для ксора или (что еще проще) написать скрипт, который "сгенерирует" лицензию и скормить ее программе:
\begin{lstlisting}[language=Python, caption=Генератор лицензии]
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

def main():
    xored = ['\x00', '\x00', '\x00', '\x00', '\x00', '\x00', '\x00',
    '\x00', '\x00', '\x09', '\x15', '\x17', '\x0c', '\x10', '\x13', 
    '\x1c', '\x00']

    with open('license.bin', 'wb') as licensefile:
        for xb in xored:
            licensefile.write(bytes(xb, 'utf-8'))


if __name__ == "__main__":
    main()
\end{lstlisting}

И получаем флаг:
\begin{figure}[H]
\begin{center}
\includegraphics[width=0.7\linewidth]{files/java-flag}
\end{center}
\caption{Привет от Intel'a}
\label{fig:java-flag}
\end{figure}

%-----------------------------------------

\experiment{easy2}

\textbf{Теги:} C, ELF32, strip, dynamic, several ways of solve\vspace{\baselineskip}

\begin{tcolorbox}
<условие задачи>
\end{tcolorbox}

Программа расшифровывает флаг и ждет от нас пароля, чтобы отдать его нам.
\begin{figure}[H]
\begin{center}
\includegraphics[width=0.5\linewidth]{files/enigma-hello}
\end{center}
\label{fig:enigma-hello}
\end{figure}

Посомтрим, что же в этот момент происходит внутри:
\begin{figure}[H]
\begin{center}
\includegraphics[width=1.0\linewidth]{files/enigma-asm}
\end{center}
\label{fig:enigma-asm}
\end{figure}

Глядя на этот листинг становится понятно, что действительно вызываются две функции. Судя по всему, одна из них для инициализации ключа, вторая для расшифровки. Таким образом, наш флга лежит в памяти еще до того, как программа спросила пароль. И тут появляется огромное количество возможных решений: к примеру, сдампить процесс, в дебаггере посмотреть содержимое кучи или, самый простой, - воспользоваться утилитой \verb|ltrace|, чтобы отследить все библиотечные вызовы - они тут есть, в этом можно убедиться, если посмотреть, что импортирует программа. Есть второй, более сложный путь решения, - увидеть, что пароль сравнивается с помощью функции \verb|strcmp| и поменять переход \verb|jnz| на \verb|jz| и, таким образом, при вводе неправильного пароля переходить на ветку, где программма печатает флаг. Ниже приведено решение с использованием \verb|ltrace|:
\begin{figure}[H]
\begin{center}
\includegraphics[width=1.0\linewidth]{files/enigma-ltrace}
\end{center}
\label{fig:enigma-asm}
\end{figure}

Как бонус, при решении через \verb|ltrace| можно также получить и пароль - это хорошо видно на скриншоте: \verb|reversegod|.

Отдельно стоит упомянуть решение "в лоб"{} - просто посидеть и прореверсить весь алгоритм. Это не так сложно - в данном случае был использован алгоритм, применявшийся в шифровальных машинах Энигма. Но для простой задачи это очень времязатратная операция, поэтому всегда стоит ставить в соответствие временные затраты и количество баллов, которые можно получить за задачу.

%----------------------------------------------------------------------------------------

\labday{Medium}

\experiment{medium}

\textbf{Теги:} C++, ELF64, strip, dynamic\vspace{\baselineskip}

\begin{tcolorbox}
<условие задачи>
\end{tcolorbox}

Суть задания - разбор очень простого бинарного формата файла. Анализируем исполняемый файл и понимает, что он парсит файл кошелька довольно простым образом:
\begin{itemize}
\item Первым байтом файла является размер зашифрованного логина, который лежит после этого байта.
\item Данный байт является инициализирующим значение для генератора гаммы с которой XOR'ится логин.
\item Такой же алгоритм используется для пароля.
\item Достаточно вытащить пароль и логин из кошелька и открыть его с помощью предоставленного исполняемого файла.
\item Теперь мы можем просматривать все поля кошелька, однако нам нужно загрузить свой кошелёк с определённым балансом.
\item Разбираем формат кошелька дальше, это не сложно делать, т.к. внутри бинарника есть функция вывода информации о кошельке, что позволяет достаточно просто и быстро определить смещения на поля и увидеть как они обрабатываются.
\item Баланс сохраняется в 4 байта после пароля и "шифруется" путём XOR'а с константой 0xdeadbeef
\item После загрузки кошелька с верным балансом, скорее всего, будет получено уведомление о том, что количество последних операций должно быть выше 16.
\item Операции сохраняются ещё проще. После баланса идёт количество операций, а следующий байт это размер операции, все операции сохраняются таким образом и шифруются XOR'ом с размером.
\item После создания операций в необходимом количестве будет получена ошибка, указывающая, что данный кошелёк не приватный. За это отвечает поле "Info".
\item Поле Info ксорится с ключом, который формируется из логина и пароля
\item Помещаем в поле Info строку "Private" (на это явно указано в сообщении об ошибке от сервера)
\item Загружаем кошелёк и покупаем токен.
\item Токен - это и есть флаг.
\end{itemize}

Таким образом, можно написать простой питоновский скрипт, который автоматизирует всю работу и просто "выдаст флаг на блюдечке с голубой коемочкой":
\begin{lstlisting}[language=Python, caption=Генератор кошелька]
#!/usr/bin/env python2
# -*- coding: utf-8 -*-

import sys
import random
import struct
import re

from pwn import *

BLANCE_KEY = 0xdeadbeef
ALPH = 'qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM0123456789'

p32 = lambda val : struct.pack( "!L", val  )
templates = ['debiting from this account %d bitcoins to %s account',
             'crediting from %s to a wallet %d bitcoins']


def idg(size = 16, chars = ALPH):
	return ''.join(random.choice(chars) for _ in range(size))


def GenRandomValue(seed):
    return (seed >> 1) & 0xff


def GenGamma(seed, sz):
    gamma = []

    for i in range(0, sz):
        value = GenRandomValue(seed)
        seed += value
        gamma.append(value)

    return gamma


def XorStringWithRandomGamma(string):
	res = ''

	seed = len(string)
	gamma = GenGamma(seed, seed)

	for i in range(len(gamma )):
		res += chr(ord(string[i]) ^ gamma[i])

	return res


class Wallet:
	login = None
	password = None
	balance = None
	last_operations = []
	info = None

	def __init__( self, Username, Password, Info ):
		self.login = Username
		self.password = Password
		self.balance = 13371337
		self.gen_random_operations()

		self.info = Info

	def gen_random_operations(self):
		global templates
		for i in range(0, 17):

			template_id = random.randint(0, 1)

			if template_id == 0:
				self.last_operations.append(templates[template_id] 
				% (random.randint(100, 512), idg()))
			else:
				self.last_operations.append(templates[template_id] 
				% (idg(), random.randint(100, 512)))

	def pack_operations(self):
		for i in range(len(self.last_operations)):
			operation = list(self.last_operations[i])

			for j in range(len(operation)):
				operation[j] = chr(ord(operation[j]) ^ len(operation))

			self.last_operations[i] = ''.join(operation)

	def pack_info( self, key ):
		self.info = list(self.info)

		for i in range( len(self.info )):
			self.info[i] = chr(ord(self.info[i]) ^ ord(key[i % len(key)]))

		self.info = ''.join(self.info)

	def pack_wallet( self ):
		self.pack_operations()

		res = ''
		# Pack login and password
		res += chr(len(self.login))
		res += XorStringWithRandomGamma(self.login)
		res += chr(len(self.password))
		res += XorStringWithRandomGamma(self.password)

		# Write balance
		res += p32(self.balance ^ BLANCE_KEY)

		# Pack all operations
		if len(self.last_operations) > 0:
			res += chr(len(self.last_operations ))

			for operation in self.last_operations:
				res += chr(len( operation ))
				res += operation
		else:
			res += "\x00\x00\x00\x00"

		self.pack_info(self.login + self.password)

		# Pack info
		if len(self.info) > 0:
			res += chr(len(self.info ))

			res += self.info
		else:
			res += "\x00\x00\x00\x00"

		return res.encode('hex')


if __name__ == "__main__":
    if len(sys.argv) > 2:
		host = sys.argv[1]
		port = int(sys.argv[2])
    else:
		print "Usage: " + sys.argv[0] + " <host> <port>"
		sys.exit(-1)

    login = 'AAAABBBBCCCCDDDD'
    password = login * 2

    wallet = Wallet(login, password, 'Private')
    enc_wallet = wallet.pack_wallet()

    r = remote(host, port)

    log.info("Upload wallet")
    r.sendline("2")

    log.info("Send wallet data")
    r.sendline(enc_wallet)

    log.info("Send login")
    r.sendline(login)

    log.info("Send password")
    r.sendline(password)

    log.info("Set as default")
    r.sendline("Y")

    log.info("Buy token")
    r.sendline("3")

    r.interactive()
\end{lstlisting}

В конце концов получаем флаг \verb|oren_ctf_REvil!|

%----------------------------------------------------------------------------------------

\labday{Hard}

\experiment{hard}

\textbf{Теги:} <Теги>\vspace{\baselineskip}

\begin{tcolorbox}
<условие задачи>
\end{tcolorbox}

%-----------------------------------------

\experiment{reallife}

\textbf{Теги:} <Теги>\vspace{\baselineskip}

\begin{tcolorbox}
<условие задачи>
\end{tcolorbox}

%----------------------------------------------------------------------------------------

\end{document}